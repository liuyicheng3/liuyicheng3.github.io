<!doctype html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta property="og:type" content="website">
<meta property="og:title" content="Nico随笔">
<meta property="og:url" content="http://yoursite.com/page/2/index.html">
<meta property="og:site_name" content="Nico随笔">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Nico随笔">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/page/2/"/>





  <title> Nico随笔 </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  














  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Nico随笔</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/10/20/App核心指标/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Liuycheng">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://github.com/liuyicheng3/learning-summary/blob/master/images/avatar.jpg?raw=true">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Nico随笔">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/10/20/App核心指标/" itemprop="url">
                  App核心指标和广告计费方式
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-10-20T00:00:00+08:00">
                2017-10-20
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="App核心指标"><a href="#App核心指标" class="headerlink" title="App核心指标"></a>App核心指标</h1><ol>
<li>pv     </li>
<li>uv     </li>
<li>ctr     </li>
<li>次日/7日留存/30日留存<br>一般目标是在40/20/10<br>参考文章：<a href="http://www.pmcaff.com/discuss/index/369885221299264?pmc_param=1" target="_blank" rel="external">http://www.pmcaff.com/discuss/index/369885221299264?pmc_param=1</a>  </li>
</ol>
<p>核心在分析哪些用户容易流失:<br><a href="http://www.woshipm.com/pmd/155084.html" target="_blank" rel="external">http://www.woshipm.com/pmd/155084.html</a></p>
<ol>
<li>dau  </li>
<li>mau</li>
<li>时长</li>
</ol>
<h1 id="内容"><a href="#内容" class="headerlink" title="内容"></a>内容</h1><ol>
<li>UGC(User-created Content):用户生产内容    </li>
<li>PGC(Professionally-generated Content):专业生产内容    </li>
</ol>
<h1 id="广告计费方式："><a href="#广告计费方式：" class="headerlink" title="广告计费方式："></a>广告计费方式：</h1><ol>
<li>CPC</li>
</ol>
<p>按点击付费，原英文为Cost Per Click 每点击成本，网络广告每次点击的费用。是做为网络广告投放效果的重要参考数据。CPC是网络广告界一种常见的定价形式。例如，关键词广告等依据效果付费的广告形式，一般采用这种定价模式。</p>
<ol>
<li>CPM</li>
</ol>
<p>按千次展示付费，其原始英文为Cost Per Mille，简称CPM。现在也有人将其译成cost per one thousand impressions 或cost per thousand。前者中文名为每千人印象成本。后者称谓相同，但简称为CPT。所指内涵与CPM相同。其计算公式为：<br>千人成本=（广告费用/到达人数）×1000。</p>
<ol>
<li>CPA</li>
</ol>
<p>按行为付费，其原始英文为 Cost Per Activity(Action)，每次动作成本，即根据每个访问者对网络广告所采取的行动收费的定价模式。对于用户行动有特别的定义，包括形成一次交易、获得一个注册用户、或者对网络广告的一次点击等。</p>
<ol>
<li>CPD</li>
</ol>
<p>按天收费，其原始英文为 Cost per day是广告合作的一种常见方式，相比当前比较流行的CPS（按销售付费 Cost per sales），优势在于对合作的基础条件没有过高要求，容易促成双方合作；劣势在于其在长期合作中，不如CPS形式实时有效。</p>
<ol>
<li>CPS</li>
</ol>
<p>按实际销售产品的提成来换算广告刊登金额，其原始英文为Cost Per Sales，CPS广告同CPA广告一样广告主为规避广告费用风险，按照广告点击之后产生的实际销售的提成付给广告站点销售提成费用。</p>
<ol>
<li>dCPM</li>
</ol>
<p>DSP普遍采用dCPM作为结算体系，dCPM指的是dynamic CPM，与目前网络广告市场长讲的CPM方式（此CPM相应的成为flat CPM）区别。dCPM基于RTB技术诞生，指的是每一次的impression出价是变化的。其每次出价均依据广告主广告投放的效果(一般是CPS）来实时计算，以得出对广告主最有利的价格，从而保证了广告主的利益。同时又因为以impression与媒体结算，也确保了媒体的收益。</p>
<p><a href="https://www.umeng.com/reports.html" target="_blank" rel="external">https://www.umeng.com/reports.html</a><br>中国移动互联网发展报告 会有说明行业普遍的留存情况</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/10/16/主题皮肤切换方案/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Liuycheng">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://github.com/liuyicheng3/learning-summary/blob/master/images/avatar.jpg?raw=true">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Nico随笔">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/10/16/主题皮肤切换方案/" itemprop="url">
                  主题皮肤切换
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-10-16T00:00:00+08:00">
                2017-10-16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="1-一个Icon图标支持两种配色"><a href="#1-一个Icon图标支持两种配色" class="headerlink" title="1. 一个Icon图标支持两种配色"></a>1. 一个Icon图标支持两种配色</h1><h3 id="1-1-通过已有的图片处理成变色图片"><a href="#1-1-通过已有的图片处理成变色图片" class="headerlink" title="1.1 通过已有的图片处理成变色图片"></a>1.1 通过已有的图片处理成变色图片</h3><p>方案就是作图的时候控制显示内容的透明度，   </p>
<p>第一步：</p>
<pre><code>Bitmap mColorBitmap = Bitmap.createBitmap(mBitmap.getWidth(), mBitmap.getHeight(), Bitmap.Config.ARGB_8888);
Canvas mCanvas = new Canvas(mColorBitmap);
Paint mPaint = new Paint();
mPaint.setColor(mColor);  
</code></pre><p>第二步：</p>
<pre><code>//从原位图中提取只包含alpha的位图
Bitmap alphaBitmap = mBitmap.extractAlpha();
//在画布上通过透明度的部分控制显示颜色
mCanvas.drawBitmap(alphaBitmap, 0, 0, mPaint);
</code></pre><p>ps：使用把图片做成字体，这样可以直接setTextColor<br>其实这和第二种的原理是相同的,只不过是UI和Android系统帮我们做了 </p>
<h3 id="1-2-ImageBitmap-和倍率的关系"><a href="#1-2-ImageBitmap-和倍率的关系" class="headerlink" title="1.2 ImageBitmap 和倍率的关系"></a>1.2 ImageBitmap 和倍率的关系</h3><p>如果不设置Density  直接把一个bitmap 设置到ImageVIew上去 就是默认density。<br>但是可能图片都是三倍图，这时候如果设置到2倍分辩率的手机上就会出现缩小的情况，这时候就要设置图片的density。<br>bitmap.setDensity(480);<br>然后再设置到imageView上去</p>
<p>关于图片的缩放系数：<a href="http://jayfeng.com/2016/03/22/Android-Bitmap%E9%9D%A2%E9%9D%A2%E8%A7%82/" target="_blank" rel="external">http://jayfeng.com/2016/03/22/Android-Bitmap%E9%9D%A2%E9%9D%A2%E8%A7%82/</a></p>
<h1 id="2-一个轻量级的换肤方案"><a href="#2-一个轻量级的换肤方案" class="headerlink" title="2.一个轻量级的换肤方案"></a>2.一个轻量级的换肤方案</h1><p><a href="https://github.com/hongyangAndroid/AndroidChangeSkin" target="_blank" rel="external">https://github.com/hongyangAndroid/AndroidChangeSkin</a>  </p>
<p>原理是定义可替换的皮肤时候带上一个后缀 </p>
<pre><code>&lt;color name=&quot;bg_theme&quot;&gt;#07172d&lt;/color&gt;
&lt;color name=&quot;bg_theme_light&quot;&gt;@color/color_eeeeee&lt;/color&gt;   
</code></pre><p>对于自定义drawble和图片资源也是一样  </p>
<pre><code>discover_icon.png   
discover_icon_light.png  
</code></pre><p>使用时候：  </p>
<pre><code>&lt;ImageView
android:drawableTop=&quot;@drawable/discover_icon&quot;
android:tag=&quot;skin:drawableTop:drawableTop|skin:tab_color:textColor&quot;
/&gt;
</code></pre><p>原理每次换肤时候遍历所有的activity，找出所有有skin标签的控件  </p>
<pre><code>private void notifyChangedListeners() {

    long time = System.currentTimeMillis();

    LinkedList&lt;Activity&gt; activityStack = LycApplication.getInstance().getActivityStack();

    for (int i = 0, size = activityStack.size(); i &lt; size; i++) {
        if (null != activityStack.get(i)) {
            Activity act= activityStack.get(i);
            if (act instanceof StoryGroundActivity || act instanceof ReviewActivity
                    || act instanceof CommentActivity) {
                apply(activityStack.get(i));
            }
        }
    }

    ELog.w(&quot; Notify ALL SKIN COST: &quot;, (System.currentTimeMillis() - time));
}
</code></pre><p>找每个元素的过程:</p>
<h3 id="1-递归遍历所有的子元素"><a href="#1-递归遍历所有的子元素" class="headerlink" title="1.递归遍历所有的子元素"></a>1.递归遍历所有的子元素</h3><pre><code>public static SkinView getSkinView(View view) {
    Object tag = view.getTag(R.id.skin_tag_id);
    if (tag == null) {
        tag = view.getTag();
    }

    if (tag == null)
        return null;

    if (!(tag instanceof String))
        return null;

    String tagStr = (String) tag;

    List&lt;SkinAttr&gt; skinAttrs = parseTag(tagStr);
    if (!skinAttrs.isEmpty()) {
        changeViewTag(view);
        return new SkinView(view, skinAttrs);
    }
    return null;
}
</code></pre><h3 id="2-解析出每个SkinView里面的自定义主题-SkinAttr"><a href="#2-解析出每个SkinView里面的自定义主题-SkinAttr" class="headerlink" title="2.解析出每个SkinView里面的自定义主题 SkinAttr"></a>2.解析出每个SkinView里面的自定义主题 SkinAttr</h3><pre><code>    private static List&lt;SkinAttr&gt; parseTag(String tagStr) {
    List&lt;SkinAttr&gt; skinAttrs = new ArrayList&lt;SkinAttr&gt;();
    if (TextUtils.isEmpty(tagStr)) return skinAttrs;

    String[] items = tagStr.split(&quot;[|]&quot;);
    for (String item : items) {
        if (!item.startsWith(SkinConfig.SKIN_PREFIX))
            continue;
        String[] resItems = item.split(&quot;:&quot;);
        if (resItems.length != 3)
            continue;

        String resName = resItems[1];
        String resType = resItems[2];

        SkinAttrType attrType = getSupprotAttrType(resType);
        if (attrType == null) continue;
        SkinAttr attr = new SkinAttr(attrType, resName);
        skinAttrs.add(attr);
    }
    return skinAttrs;
}
</code></pre><h3 id="3-应用新的主题"><a href="#3-应用新的主题" class="headerlink" title="3.应用新的主题"></a>3.应用新的主题</h3><p>SkinView apply主题的方法：</p>
<pre><code>public void apply() {
    if (view == null) return;

    for (SkinAttr attr : attrs) {
        attr.apply(view);
    }
}
</code></pre><p>SkinAttr 具体设置主题的方法    </p>
<pre><code>HintCOLOR(&quot;textColorHint&quot;) {
    @Override
    public void apply(View view, String resName) {
        ColorStateList colorlist = getResourceManager().getColorStateList(resName);
        if (colorlist == null)
            return;

        ((EditText) view).setHintTextColor(colorlist);
    }
},
</code></pre><p>ps： SkinAttrType写的方式很不错，值得学习</p>
<h3 id="踩坑笔录"><a href="#踩坑笔录" class="headerlink" title="踩坑笔录"></a>踩坑笔录</h3><ul>
<li>区别drawable 是color 还是 drawable:</li>
</ul>
<pre><code> BACKGROUND(&quot;background&quot;) {
    @Override
    public void apply(View view, String resName) {

        String targetResName = getResourceManager().appendSuffix(resName);
        Resources mResources=view.getContext().getResources();
        try {
            int colorResult= mResources.getColor(mResources.getIdentifier(targetResName, &quot;color&quot;, view.getContext().getPackageName()));
            view.setBackgroundColor(colorResult);
        }catch ( Exception e1){
            try {
                int resId=mResources.getIdentifier(targetResName, &quot;drawable&quot;, view.getContext().getPackageName());
                Drawable drawableResult= mResources.getDrawable(resId);
                if (drawableResult == null)
                    return;
                view.setBackgroundResource(resId);
            }catch (Exception e2){
                ELog.e(&quot;not found:&quot;+targetResName);
            }
        }


    }
},
</code></pre><ul>
<li>SkinManager 没有保存SkinView的引用  </li>
</ul>
<p>实际上每次应用主题时候 都是遍历存在Application的Activity列表然后find 每个SkinView  然后应用主题皮肤</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/10/11/Android历代版本新特性/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Liuycheng">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://github.com/liuyicheng3/learning-summary/blob/master/images/avatar.jpg?raw=true">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Nico随笔">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/10/11/Android历代版本新特性/" itemprop="url">
                  Android版本更新特性
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-10-11T00:00:00+08:00">
                2017-10-11
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="1-Android-3-0"><a href="#1-Android-3-0" class="headerlink" title="1. Android 3.0"></a>1. Android 3.0</h2><ul>
<li>硬件加速  </li>
</ul>
<h2 id="2-Android-4-1"><a href="#2-Android-4-1" class="headerlink" title="2. Android 4.1"></a>2. Android 4.1</h2><ul>
<li>黄油计划</li>
</ul>
<h2 id="3-Android-4-4"><a href="#3-Android-4-4" class="headerlink" title="3. Android 4.4"></a>3. Android 4.4</h2><ul>
<li>推出art 但是默认还是davilk</li>
<li>对齐唤醒：把AlarmManager的默认方法改用了对齐但不保证准确的模式</li>
</ul>
<h2 id="4-Android-5"><a href="#4-Android-5" class="headerlink" title="4. Android 5"></a>4. Android 5</h2><ul>
<li>Android Runtime (ART)默认运行平台设置  </li>
<li>引入Material Design设计</li>
<li>转场动画  </li>
</ul>
<h4 id="保活注意点："><a href="#保活注意点：" class="headerlink" title="保活注意点："></a>保活注意点：</h4><p>在5.0以前使用LibMarsdeamon的保活方法<br>在5.0以后使用JobScheduler进行保活   </p>
<p>JobScheduler使用系统定义要在以后的某个时间或在指定的条件下（例如，当设备在充电时）异步运行的作业来优化电池寿命    </p>
<pre><code>JobInfo.Builder builder = new JobInfo.Builder(job,
                        new ComponentName(ApplicationManager.ctx, CustomJobSchedulerService.class));
    builder.setPeriodic(3000);// 每隔三秒运行一次  设置太小会无效
    builder.setPersisted(true);

    JobScheduler jobScheduler = (JobScheduler) ApplicationManager.ctx.
            getSystemService(Context.JOB_SCHEDULER_SERVICE);
    if (jobScheduler!=null) {
        jobScheduler.schedule(builder.build());
    }
</code></pre><h2 id="Android-6-0"><a href="#Android-6-0" class="headerlink" title="Android 6.0"></a>Android 6.0</h2><ul>
<li>运行时请求权限</li>
<li>Doze mode：应用不在白名单,系统灭屏经过大约一小时后,上层应用wake lock,alarm,还有网络链接都会失效<br>参考链接： <a href="http://blog.csdn.net/xiaorenwu1206/article/details/49358433" target="_blank" rel="external">http://blog.csdn.net/xiaorenwu1206/article/details/49358433</a>  </li>
</ul>
<h2 id="Android7-0"><a href="#Android7-0" class="headerlink" title="Android7.0"></a>Android7.0</h2><ul>
<li>分屏</li>
<li>加强版的Doze模式：N与6.0的区别就在于N在手机非静止时也可进入低电耗模式  </li>
<li>Project Svelte：后台优化</li>
</ul>
<h2 id="Android-8-0"><a href="#Android-8-0" class="headerlink" title="Android 8.0"></a>Android 8.0</h2><ul>
<li>优化通知</li>
</ul>
<h3 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h3><ol>
<li><a href="https://www.jianshu.com/p/8a66806588bc" target="_blank" rel="external">https://www.jianshu.com/p/8a66806588bc</a></li>
</ol>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/10/10/点赞爱心动画/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Liuycheng">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://github.com/liuyicheng3/learning-summary/blob/master/images/avatar.jpg?raw=true">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Nico随笔">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/10/10/点赞爱心动画/" itemprop="url">
                  点赞爱心动画
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-10-10T00:00:00+08:00">
                2017-10-10
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="场景"><a href="#场景" class="headerlink" title="场景"></a>场景</h1><p> 实现直播房间点赞爱心动画（不是送礼物的动画）<br> 难点：流畅的飘爱心</p>
<h1 id="1-方案1"><a href="#1-方案1" class="headerlink" title="1. 方案1"></a>1. 方案1</h1><p>直接使用animator做动画<br>参考资料： <a href="https://github.com/Yasic/QQBubbleView" target="_blank" rel="external">https://github.com/Yasic/QQBubbleView</a>  </p>
<h3 id="1-1-优化方向："><a href="#1-1-优化方向：" class="headerlink" title="1.1. 优化方向："></a>1.1. 优化方向：</h3><ol>
<li>削峰</li>
<li>不要每次都inflate layout，尝试模拟listview的recycleBin 对用跑完动画的View 重新赋值初始化</li>
</ol>
<h2 id="2-方案2："><a href="#2-方案2：" class="headerlink" title="2. 方案2："></a>2. 方案2：</h2><p>直接在View上绘制爱心<br>参考资料：<a href="https://github.com/HomHomLin/Android-DivergeView" target="_blank" rel="external">https://github.com/HomHomLin/Android-DivergeView</a><br>核心就是一个while循环，不断计算当前爱心的位置</p>
<pre><code>while (mRunning) {
    if (mQueen == null) {
        continue;
    }
    if (mIsDrawing) {
        //如果正在绘制，不要处理数据
        continue;
    }
    dealQueen();
    dealDiverge();
    mIsDrawing = true;
    postInvalidate();
}
</code></pre><p>在dealQueen里面处理正在等待走动画的点赞  </p>
<pre><code>if (mQueen.size() &gt; 0 &amp;&amp; now - mLastAddTime &gt; mQueenDuration) {
        mLastAddTime = System.currentTimeMillis();
        DivergeInfo divergeInfo = null;
        if (mDeadPool.size() &gt; 0) {
            //死池里面有空闲的divergeNode
            divergeInfo = mDeadPool.get(0);
            mDeadPool.remove(0);
        }
        if (divergeInfo == null) {
            divergeInfo = createDivergeNode(mQueen.get(0));
        }
        divergeInfo.reset();
        divergeInfo.mType = mQueen.get(0);
        mDivergeInfos.add(divergeInfo);
        mQueen.remove(0);
    }
</code></pre><p>在dealDiverge里面计算已经在走动画的爱心的位置  </p>
<pre><code>for (int i = 0; i &lt; mDivergeInfos.size(); i++) {
       DivergeInfo divergeInfo = mDivergeInfos.get(i);
       float timeLeft = 1.0F - divergeInfo.mDuration;
       divergeInfo.mDuration += mDuration;
       float x, y;
       //二次贝塞尔
       float time1 = timeLeft * timeLeft;
       float time2 = 2 * timeLeft * divergeInfo.mDuration;
       float time3 = divergeInfo.mDuration * divergeInfo.mDuration;
       x = time1 * (mPtStart.x)
               + time2 * (divergeInfo.mBreakPoint.x)
               + time3 * (divergeInfo.mEndPoint.x);

       divergeInfo.mX = x;

       y = time1 * (mPtStart.y)
               + time2 * (divergeInfo.mBreakPoint.y)
               + time3 * (divergeInfo.mEndPoint.y);

       divergeInfo.mY = y;

       if (divergeInfo.mY &lt;= divergeInfo.mEndPoint.y) {
           mDivergeInfos.remove(i);
           mDeadPool.add(divergeInfo);
           i--;
           continue;
       }
   }
</code></pre><p>onDraw方法</p>
<pre><code>for (DivergeInfo divergeInfo : mDivergeInfos) {
          mPaint.setAlpha((int) (255 * divergeInfo.mY / mPtStart.y));
          Bitmap bm = mDivergeViewProvider.getBitmap(divergeInfo.mType);
          float originCenterX = divergeInfo.mX + bm.getWidth() / 2;
          float originCenterY = divergeInfo.mY + bm.getHeight() / 2;
          float scaleWidth, scaleHeight;               
          scaleWidth = bm.getWidth();
          scaleHeight = bm.getHeight();
          RectF destRect = new RectF(originCenterX - scaleWidth / 2, originCenterY - scaleHeight / 2,
                  originCenterX + scaleWidth / 2, originCenterY + scaleHeight / 2);
          canvas.drawBitmap(bm, null
                  , destRect,
                  mPaint);
      }
 mIsDrawing = false;
</code></pre><p>ps：映客的点赞爱心就是这么实现的（映客是本地点赞出爱心，这个直接分析元素会失败，可以进入直播后，断网然后分析元素）</p>
<h3 id="2-1-优化方向："><a href="#2-1-优化方向：" class="headerlink" title="2.1. 优化方向："></a>2.1. 优化方向：</h3><ol>
<li>停止爱心动画的时机（什么时候可以停止while循环）</li>
<li>削峰：Android 每隔 16.6 ms 刷新一次屏幕，可以根据这个计算一次主流机型阈值</li>
</ol>
<p>都需要利用到削峰</p>
<h1 id="额外知识点"><a href="#额外知识点" class="headerlink" title="额外知识点"></a>额外知识点</h1><p>二阶贝塞尔曲线公式：<br><img src="https://gss2.bdstatic.com/9fo3dSag_xI4khGkpoWK1HF6hhy/baike/s%3D317/sign=9aefef4b08f79052eb1f413f3bf2d738/11385343fbf2b21129581916cb8065380cd78e70.jpg" alt="二阶">    </p>
<p>三阶贝塞尔曲线公式：<br><img src="https://gss0.bdstatic.com/-4o3dSag_xI4khGkpoWK1HF6hhy/baike/s%3D421/sign=9a6521eab8014a90853e47bf98763971/f603918fa0ec08fad54f8dff58ee3d6d55fbda1f.jpg" alt="三阶">    </p>
<p>在线演示：<a href="http://myst729.github.io/bezier-curve/" target="_blank" rel="external">http://myst729.github.io/bezier-curve/</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/10/01/简易java热补丁/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Liuycheng">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://github.com/liuyicheng3/learning-summary/blob/master/images/avatar.jpg?raw=true">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Nico随笔">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/10/01/简易java热补丁/" itemprop="url">
                  热补丁
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-10-01T20:10:33+08:00">
                2017-10-01
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="核心两个部分"><a href="#核心两个部分" class="headerlink" title="核心两个部分"></a>核心两个部分</h2><h3 id="1-hook部分"><a href="#1-hook部分" class="headerlink" title="1. hook部分"></a>1. hook部分</h3><p>hook部分主要是使用反射调用补丁里面的内容</p>
<p>hook部分的本质是提供对补丁方法调用的封装（主工程无法直接实例和调用补丁的方法），每次调用都是通过反射调用，传入activity，handler，callback进去。</p>
<h3 id="2-补丁部分"><a href="#2-补丁部分" class="headerlink" title="2. 补丁部分"></a>2. 补丁部分</h3><p>补丁实际上是java代码转的dex<br>它的工作有两种：网络取数据，构造生成view</p>
<p>补丁部分构造view是通过hook部分传过来activity，然后用代码动态构造view，不涉及到任何布局文件，资源文件。  </p>
<h2 id="hook的初始化及调用过程"><a href="#hook的初始化及调用过程" class="headerlink" title="hook的初始化及调用过程"></a>hook的初始化及调用过程</h2><ol>
<li><p>初始化DexClassLoader  </p>
<pre><code>classLoader = new DexClassLoader(dexApkFilePath
            + dexName + &quot;.apk&quot;, context.getDir(&quot;dex&quot;, Context.MODE_PRIVATE).getAbsolutePath(), null,
            context.getClassLoader().getParent());
</code></pre></li>
<li><p>load补丁相应的class  </p>
<pre><code>controllerClass = classLoader.loadClass(&quot;com.nico.Controller&quot;);
</code></pre></li>
<li><p>初始化构造函数</p>
<pre><code>controllerConstrucor = controllerClass.getConstructor(new Class[]{Context.class, String.class, boolean.class});
</code></pre></li>
<li><p>实例化补丁里面的类</p>
<pre><code>controllerInstance = controllerConstrucor.newInstance(new Object[]{mContext});
</code></pre></li>
<li><p>通过初始化的实例controllerInstance来调用里面的方法  </p>
<pre><code>Method initController = controllerClass.getDeclaredMethod(&quot;initController&quot;, new Class[]{String.class, String.class, String.class});
initController.setAccessible(true);
initController.invoke(controllerInstance, new Object[]{paramsA, paramsB, paramsC});
</code></pre></li>
</ol>
<h2 id="补丁的升级"><a href="#补丁的升级" class="headerlink" title="补丁的升级"></a>补丁的升级</h2><ol>
<li>校验是否有新的版本升级</li>
<li>把新的补丁下载到本地sd卡中去</li>
<li>解压补丁到data/data/app.pkg/app_dex目录<br>ZipManager.extNativeZipFile(mContext,<pre><code>mContext.getResources().getAssets().open(Utils.ZIP_NAME),
cachePath, dexApkFilePath, lastVersion)
</code></pre></li>
<li>重新走一遍补丁的实例化过程（从DexLoader开始）</li>
</ol>
<h2 id="坑"><a href="#坑" class="headerlink" title="坑"></a>坑</h2><ol>
<li>第一次安装，补丁放到asset目录下面</li>
<li>由于里面传入了activity，要注意销毁补丁里面的强引用</li>
</ol>
<h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><p>dexclassloader : 可以加载apk文件中的字节码<br>pathclassloader : 只能加载文件目录下的apk文件中的classes</p>
<h2 id="To-Be-Continue"><a href="#To-Be-Continue" class="headerlink" title="To Be Continue"></a>To Be Continue</h2><ol>
<li><p>load补丁里面的资源文件 ,通过反射调用AssetManger里面的资源文件，把ID设置上去 </p>
<pre><code>AssetManager assetManager = AssetManager.class.newInstance();  
Method addAssetPath = assetManager.getClass().getMethod(&quot;addAssetPath&quot;, String.class);  
addAssetPath.invoke(assetManager, libPath);  
Resources superRes = super.getResources();  
mRes = new Resources(assetManager, superRes.getDisplayMetrics(), superRes.getConfiguration());
</code></pre></li>
<li><p>尝试使用mvp模式，把controllor从activity里面剥离开来，让所有contollor可以被热补丁，这要处理起来（可以把整个app轻量化）</p>
</li>
</ol>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p><a href="http://blog.csdn.net/wwj_748/article/details/46349781" target="_blank" rel="external">http://blog.csdn.net/wwj_748/article/details/46349781</a></p>
<p><a href="http://blog.csdn.net/yuanzeyao/article/details/42390431" target="_blank" rel="external">http://blog.csdn.net/yuanzeyao/article/details/42390431</a></p>
<p><a href="http://blog.csdn.net/u010386612/article/details/51077291" target="_blank" rel="external">http://blog.csdn.net/u010386612/article/details/51077291</a></p>
<p><a href="http://blog.csdn.net/cn_foolishman/article/details/46874811" target="_blank" rel="external">http://blog.csdn.net/cn_foolishman/article/details/46874811</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/09/10/android全屏模键盘冲突/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Liuycheng">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://github.com/liuyicheng3/learning-summary/blob/master/images/avatar.jpg?raw=true">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Nico随笔">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/09/10/android全屏模键盘冲突/" itemprop="url">
                  全屏模式底部键盘冲突
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-09-10T00:00:00+08:00">
                2017-09-10
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="场景：全屏模式下activity的adjustResize-失效-弹键盘时候底部的输入框无法自动调整到键盘区域的上方"><a href="#场景：全屏模式下activity的adjustResize-失效-弹键盘时候底部的输入框无法自动调整到键盘区域的上方" class="headerlink" title="场景：全屏模式下activity的adjustResize 失效,弹键盘时候底部的输入框无法自动调整到键盘区域的上方"></a>场景：全屏模式下activity的adjustResize 失效,弹键盘时候底部的输入框无法自动调整到键盘区域的上方</h1><h2 id="1-方案一："><a href="#1-方案一：" class="headerlink" title="1. 方案一："></a>1. 方案一：</h2><p>使用 AndroidBug5497Workaround （<a href="https://stackoverflow.com/questions/7417123/android-how-to-adjust-layout-in-full-screen-mode-when-softkeyboard-is-visible）" target="_blank" rel="external">https://stackoverflow.com/questions/7417123/android-how-to-adjust-layout-in-full-screen-mode-when-softkeyboard-is-visible）</a>  </p>
<p><img src="https://github.com/liuyicheng3/learning-summary/blob/master/images/planA_normal.gif?raw=true" height="200px" width="100px">  </p>
<p>原理：通过 getViewTreeObserver().addOnGlobalLayoutListener监听当前屏幕显示区域的大小，然后动态调整Activity rootView的height，实现“adjust resize”的效果   </p>
<pre><code> Rect r = new Rect();
 mChildOfContent.getWindowVisibleDisplayFrame(r);
int usableHeightNow = r.bottom - r.top;
  if (usableHeightNow != usableHeightPrevious) {
      int usableHeightSansKeyboard = mChildOfContent.getRootView().getHeight();
      int heightDifference = usableHeightSansKeyboard - usableHeightNow;
      if (heightDifference &gt; (usableHeightSansKeyboard/4)) {
          // keyboard probably just became visible
          frameLayoutParams.height = usableHeightSansKeyboard - heightDifference;
      } else {
          // keyboard probably just became hidden
          frameLayoutParams.height = usableHeightSansKeyboard;
      }
      mChildOfContent.requestLayout();
      usableHeightPrevious = usableHeightNow;
</code></pre><p>但是这个不能完全解决我们问题，会遇到下面的问题：<br>在输入框在屏幕区域上方是没问题，在输入框在底部时候，会有一个特别不好的现象，键盘弹出后会迅速把整个Activity完全顶上去，然后调整回来。  </p>
<p><img src="https://github.com/liuyicheng3/learning-summary/blob/master/images/planA.gif?raw=true" height="200px" width="100px"></p>
<p>问题的原因是是OnGlobalLayoutListener不是实时和键盘弹时屏幕显示区域同步的。所以就会在键盘弹起的瞬间先把整个activity顶上去，然后顶上去后，屏幕内容又会掉下来  </p>
<p>补丁方案：<br>输入框在底部时候不要直接弹出键盘，先让顶部的一个1px的输入框获得这个这个焦点，待键盘完全弹出来后再把焦点传递给底部的这个输入框，这样就不会有顶整个界面起来的现象</p>
<p><img src="https://github.com/liuyicheng3/learning-summary/blob/master/images/planA_fix.gif?raw=true" height="200px" width="100px"></p>
<p>补充问题<br>为什么在顶部的时候不会出现顶上去又下来的情况？<br>因为 输入框在最上面，键盘输入法只要弹出时不盖住输入框，就不会顶起这个Activity的内容，而内容区域调整也是延迟于键盘弹起速度的，但是由于键盘盖住了所以视觉感觉不出来    </p>
<h4 id="虚拟按键"><a href="#虚拟按键" class="headerlink" title="虚拟按键"></a>虚拟按键</h4><p>注意android的虚拟按键有两种：<br>一种是N5 N6一类的固定在底部的虚拟按键  </p>
<p>一种是华为 小米mix 一类的的  可以通过手势动态控制底部虚拟按键显示还隐藏<br>这种就需要动态计算高度  </p>
<p>为了解决A问题，需要在顶部放置一个fake EditText ，点击目标EditText时候先让顶部的fakeEditText获得焦点，待键盘完全弹出来后再把焦点转移给目标EditText<br>具体方案：目标EditText监控ontouch事件，在TouchUp时候消耗掉这个事件，这样就不会触发键盘直接弹出来了，这时候，顶部的 fake EditText先获取焦点，延迟一段时间 待键盘完全弹出后再让目标EditText获取焦点</p>
<h2 id="2-方案二"><a href="#2-方案二" class="headerlink" title="2.方案二"></a>2.方案二</h2><p>JkeyboardSwitch （<a href="https://github.com/Jacksgong/JKeyboardPanelSwitch）" target="_blank" rel="external">https://github.com/Jacksgong/JKeyboardPanelSwitch）</a>  </p>
<p>原理是在输入框下面加了一个和键盘高度相同的panel，在键盘弹出来的瞬间panel显示出来（invisualble状态），这样键盘的弹出和隐藏与panel的的invisualble和gone的状态同步起来，看起来的效果就是键盘出来时候把输入框顶上去，键盘收起来时候把输入框收回去  </p>
<p>这个方案的一个问题是“怎么在第一次弹出时候初始化panel高度和键盘高度一致?”    </p>
<p><img src="https://github.com/liuyicheng3/learning-summary/blob/master/images/planB.gif?raw=true" height="200px" width="100px"></p>
<p>补丁方案：<br>第一次弹出瞬间把输入框的区域设置为Invisualbel ，初始panel的高度尽量大，待键盘完全弹出后把输入框区域显示出来，然后调整panel的高度，这样就能在用户无察觉的情况初始化这个panel高度。   </p>
<p><img src="https://github.com/liuyicheng3/learning-summary/blob/master/images/planB_fix.gif?raw=true" height="200px" width="100px"></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/08/10/图片不同尺寸缓存的优化方案/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Liuycheng">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://github.com/liuyicheng3/learning-summary/blob/master/images/avatar.jpg?raw=true">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Nico随笔">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/08/10/图片不同尺寸缓存的优化方案/" itemprop="url">
                  又拍云图片显示优化
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-08-10T00:00:00+08:00">
                2017-08-10
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="1-又拍云的图片尺寸问题"><a href="#1-又拍云的图片尺寸问题" class="headerlink" title="1. 又拍云的图片尺寸问题"></a>1. 又拍云的图片尺寸问题</h2><p>又拍云会对我们上传的图片进行处理。然后会生成多种尺寸：110,160,210,240,320,480,640,720,1200。<br>每种尺寸对应于不同的url。<br>eg：<br><a href="http://img2048.static.suishenyun.net/d62bb1e1bf1e2c6b8fb0dd004a952a01/4414fc28822e3643ff90a7e68305e12a.jpg!w480.jpg" target="_blank" rel="external">http://img2048.static.suishenyun.net/d62bb1e1bf1e2c6b8fb0dd004a952a01/4414fc28822e3643ff90a7e68305e12a.jpg!w480.jpg</a></p>
<h2 id="2-简单的解决方案"><a href="#2-简单的解决方案" class="headerlink" title="2. 简单的解决方案"></a>2. 简单的解决方案</h2><p>为了利用又拍云自动帮我们处理出来的不同尺寸图片。在每次加载图片的时候根据当前显示View的尺寸加载合适的尺寸</p>
<h3 id="2-1-这里有三个没解决的问题："><a href="#2-1-这里有三个没解决的问题：" class="headerlink" title="2.1 这里有三个没解决的问题："></a>2.1 这里有三个没解决的问题：</h3><ol>
<li><p>不同尺寸的图片会在sd卡上存不同cache，比如由于我们先加载了640尺寸的图片，后面加载480尺寸还是无法公用640尺寸的图片cache,导致还得重新请求一次网络。实际上我们可以通过处理得到480尺寸的图片。</p>
</li>
<li><p>对于发带图片帖子的这种逻辑处理逻辑处理不方便。因为上传图片后，很有可能不知道图片的显示尺寸。无法把这张本地图片放置到对应位置的cache上去（虽然我们现在上传上去后，会直接显示的是本地图片，但这个有点治标不治本。第二次进来时候或者下拉刷新后 还是会从网上load这张图片）。</p>
</li>
<li><p>图片尺寸的获取，不是所有的ImageView在setImageUrl时候都可以获取尺寸，有的量不到尺寸，也就是在一个还没有渲染 并且也没有设置固定size的ImageVIew上设置Url（比Adapter里面的初次createView  然后立即设置Url就会出现量不到尺寸的问题）</p>
</li>
</ol>
<p>总结一些：又拍云会帮我们处理出来不同尺寸的图片。在小的地方我们可以仅仅加载小尺寸的图片，提高了展示速度。但是对于同一张图片，在不同地方展示不同尺寸的逻辑处理不够完美。所以以前在wecal里面会发现一个问题：同一个头像，已经展示过了，在下一个页面里用另个尺寸展示的时候还是会有点慢。 </p>
<h2 id="3-对于又拍云的图片完美解决方案"><a href="#3-对于又拍云的图片完美解决方案" class="headerlink" title="3. 对于又拍云的图片完美解决方案"></a>3. 对于又拍云的图片完美解决方案</h2><p>核心需要在内存和sd卡缓存逻辑能够识别出不同尺寸的不同图片。也就是要每一url对应于一组cache。</p>
<p>代码实现上就是要把当前的url的cache对应到一组cache 上去。<br><img src="https://github.com/liuyicheng3/learning-summary/blob/master/images/%E5%9B%BE%E7%89%87%E5%8A%A0%E8%BD%BD01.png?raw=true" alt=""></p>
<h3 id="3-1-Memery-cache逻辑"><a href="#3-1-Memery-cache逻辑" class="headerlink" title="3.1 Memery cache逻辑"></a>3.1 Memery cache逻辑</h3><p>对于内存cache 建议还是按照以前的逻辑走，但是可以加上对于一个尺寸的的图片可以使用相近已经缓存尺寸的图片。</p>
<h3 id="3-2-Disk-cache逻辑"><a href="#3-2-Disk-cache逻辑" class="headerlink" title="3.2 Disk cache逻辑"></a>3.2 Disk cache逻辑</h3><p>对于Disk cache 。如果需要加载一个小尺寸的图片，但是发现只有大尺寸图片，我们可以直接使用大图压缩出小图，返回过去。<br><img src="https://github.com/liuyicheng3/learning-summary/blob/master/images/%E5%9B%BE%E7%89%87%E5%8A%A0%E8%BD%BD02.png?raw=true" alt=""></p>
<h3 id="3-3-2G网络模式"><a href="#3-3-2G网络模式" class="headerlink" title="3.3 2G网络模式"></a>3.3 2G网络模式</h3><p>在低速网络情况下，对于disk cache，如果发现没有当前尺寸的图片的情况下，可以使用任意尺寸的缓存转化。</p>
<h2 id="5-推荐一个图片压缩库"><a href="#5-推荐一个图片压缩库" class="headerlink" title="5. 推荐一个图片压缩库"></a>5. 推荐一个图片压缩库</h2><p>Luban：<a href="https://github.com/Curzibn/Luban" target="_blank" rel="external">https://github.com/Curzibn/Luban</a>      大小仅仅是15K</p>
<p>根据我的测试一般可以在不明显影响图片展示效果的条件减少图片体积2/3。使用它后发图片备注速度飞快。（在wecal里面默认发送压缩后的图片，也提供发送原图的可选项）</p>
<h2 id="相关推荐"><a href="#相关推荐" class="headerlink" title="相关推荐"></a>相关推荐</h2><p>Glide的ModuleLoader：<a href="https://github.com/bumptech/glide/wiki/Downloading-custom-sizes-with-Glide" target="_blank" rel="external">https://github.com/bumptech/glide/wiki/Downloading-custom-sizes-with-Glide</a><br>Android图片缓存之Glide进阶： <a href="http://www.cnblogs.com/whoislcj/p/5565012.html" target="_blank" rel="external">http://www.cnblogs.com/whoislcj/p/5565012.html</a><br>ModelLoader: <a href="https://muyangmin.github.io/glide-docs-cn/tut/custom-modelloader.html#%E5%9C%A8-modelloader-%E4%B8%AD%E5%A4%84%E7%90%86%E8%87%AA%E5%AE%9A%E4%B9%89%E5%B0%BA%E5%AF%B8" target="_blank" rel="external">https://muyangmin.github.io/glide-docs-cn/tut/custom-modelloader.html#%E5%9C%A8-modelloader-%E4%B8%AD%E5%A4%84%E7%90%86%E8%87%AA%E5%AE%9A%E4%B9%89%E5%B0%BA%E5%AF%B8</a>   </p>
<p><a href="https://github.com/bumptech/glide/blob/b4b45791cca6b72345a540dcaa71a358f5706276/samples/giphy/src/main/java/com/bumptech/glide/samples/giphy/GiphyModelLoader.java#L31" target="_blank" rel="external">https://github.com/bumptech/glide/blob/b4b45791cca6b72345a540dcaa71a358f5706276/samples/giphy/src/main/java/com/bumptech/glide/samples/giphy/GiphyModelLoader.java#L31</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/08/03/AMS浅析_02/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Liuycheng">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://github.com/liuyicheng3/learning-summary/blob/master/images/avatar.jpg?raw=true">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Nico随笔">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/08/03/AMS浅析_02/" itemprop="url">
                  AMS server端分析
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-08-03T00:00:00+08:00">
                2017-08-03
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Ams-server端"><a href="#Ams-server端" class="headerlink" title="Ams  server端"></a>Ams  server端</h1><h2 id="核心类："><a href="#核心类：" class="headerlink" title="核心类："></a>核心类：</h2><p>ActivityManagerNative是从Client接受binder 消息<br>ApplicationThreadNative 是从AMS向Client发送指令<br>ActivityStackSupervisor<br>ActivityStack就是存储ActivityRecord的容器，主要操作都是通过ActivityStackSupervisor来做的</p>
<p>ps:注意接IApplicationThread   </p>
<pre><code>A. ApplicationThreadNative实现了一部分，ActivityMangerService继承ApplicationThreadNative,然后实现了剩余的    
B. ApplicationThreadNative.ApplicationThreadProxy完全实现了IApplicationThread
</code></pre><h2 id="Activity-A启动Activity-B流程"><a href="#Activity-A启动Activity-B流程" class="headerlink" title="Activity A启动Activity B流程"></a>Activity A启动Activity B流程</h2><h2 id="1-Activity-A启动Activity-B流程"><a href="#1-Activity-A启动Activity-B流程" class="headerlink" title="1. Activity A启动Activity B流程"></a>1. Activity A启动Activity B流程</h2><p>ActivityManagerNative#onTransact（）&gt;&gt;<br>ActivityManagerService#startActivity()&gt;&gt;<br>ActivityManagerService#startActivityAsUser()&gt;&gt;<br>ActivityStackSupervisor#startActivityMayWait()&gt;&gt;<br>ActivityStack#resumeTopActivityLocked（）&gt;&gt;<br>ActivityStack#startPausingLocked（）&gt;&gt;<br>pause上一个Activity的调用方法</p>
<pre><code>prev.app.thread.schedulePauseActivity(prev.appToken, prev.finishing,  userLeaving, prev.configChangeFlags);
</code></pre><p>ActivityMangerNative.ApplicationThreadProxy.schedulePauseActivity  &gt;&gt;<br>）</p>
<p>等client pause完了后<br>ActivityManagerNative#activityPaused（）<br>这里实际调用的是ActivityManagerService的activityPaused（）&gt;&gt;<br>ActivityStack#completePauseLocked() &gt;&gt;<br>ActivityStack#resumeTopActivityLocked（）&gt;&gt;<br>ActivityStackSupervisor#resumeTopActivitiesLocked(topStack, prev, null);  </p>
<p>这时候有两部分，如果当前应用还没有启动就通过Process  </p>
<pre><code>    if (app != null &amp;&amp; app.thread != null) {
        try {
            app.addPackage(r.info.packageName, mService.mProcessStats);
            realStartActivityLocked(r, app, andResume, checkConfig);
            return;
        } catch (RemoteException e) {
            Slog.w(TAG, &quot;Exception when starting activity &quot;
                    + r.intent.getComponent().flattenToShortString(), e);
        }

        // If a dead object exception was thrown -- fall through to
        // restart the application.
    }

    mService.startProcessLocked(r.processName, r.info.applicationInfo, true, 0,
            &quot;activity&quot;, r.intent.getComponent(), false, false, true);
}
</code></pre><h3 id="1-1-在已有进程中启动"><a href="#1-1-在已有进程中启动" class="headerlink" title="1.1 在已有进程中启动"></a>1.1 在已有进程中启动</h3><p>ActivityStackSupervisor#realStartActivityLocked（）&gt;&gt;  </p>
<pre><code>app.thread.scheduleLaunchActivity(new Intent(r.intent), r.appToken,
System.identityHashCode(r), r.info,
new Configuration(mService.mConfiguration), r.compat,
app.repProcState, r.icicle, results, newIntents, !andResume,
mService.isNextTransitionForward(), profileFile, profileFd,profileAutoStop;  
</code></pre><p>ActivityMangerNative.ApplicationThreadProxy.scheduleLaunchActivity  &gt;&gt;  </p>
<h3 id="1-2-App进程不存在，需要新建"><a href="#1-2-App进程不存在，需要新建" class="headerlink" title="1.2 App进程不存在，需要新建"></a>1.2 App进程不存在，需要新建</h3><p>ActivityManagerService#startProcessLocked()&gt;&gt;      </p>
<h4 id="1-2-1-fork一个新的进程的三个步骤："><a href="#1-2-1-fork一个新的进程的三个步骤：" class="headerlink" title="1.2.1 fork一个新的进程的三个步骤："></a>1.2.1 fork一个新的进程的三个步骤：</h4><p>①AMS通过Socket通信，向Zygote发送一个创建进程请求，Zygote创建新进程。<br>②创建好进程后，调用ActivityThread.main()。到此，我们到了新了一个进程中，也是程序的入口出。<br>③调用ActivityThread.attach()开始新的应用程序，接着同过Binder通信通知AMS，新的进程已经创建好了，可以开始新的程序了。  </p>
<h4 id="1-2-2-ActivityManagerNative-attachApplication"><a href="#1-2-2-ActivityManagerNative-attachApplication" class="headerlink" title="1.2.2  ActivityManagerNative.attachApplication()"></a>1.2.2  ActivityManagerNative.attachApplication()</h4><p>ps：实际调用的是ActivityManagerService.attachApplication<br>①根据Binder.getCallingPid(),或得客户进程pid，并调用attachApplicationLocked(IApplicationThreadthread,int pid)<br>②在attachApplicationLocked中，根据pid找到对应的ProcessRecord对象，如果找不到说明改pid客户进程是一个没经过AMS允许的进程。<br>③为ProcessRecordapp对象内部变量赋值<br>④确保目标程序（APK）文件已经被转换为了odex文件。Android中安装程序是APK文件，实际上是一个zip文件。<br>⑤调用ActivityStack.realStartActivityLocked通知客户进程运行指定Activity.<br>⑥调用ApplicationThread.scheduleLaunchActivity，启动指定Activity。  </p>
<h4 id="1-2-3-客户进程启动指定Activity"><a href="#1-2-3-客户进程启动指定Activity" class="headerlink" title="1.2.3 客户进程启动指定Activity"></a>1.2.3 客户进程启动指定Activity</h4><p>AMS通过IPC通行，通知客户进程启动指定Activity：<br>①调用ApplicationThread.scheduleLaunchActivity<br>②经过Handler消息传动，调用ActivityThread.handleLaunchActivity()<br>③调用ActivityThread.performLaunchActivity()完成Activity的加载，并最终调用Activity生命周期的onCreate()方法<br>④performLaunchActivity返回，继续调用ActivityThread.handleResumeActivity(),该方法内部又调用ActivityThread.performResumeActivity(),其内部仅仅调用了目标Activity的onResume()方法。到此Activity启动完成。<br>⑤添加一个IdleHandler对象，因为在一般情况下，该步骤执行完毕后，Activity就会进入空闲状态，所以就可以进行内存回收。  </p>
<h2 id="2-ActivityStack-、TaskRecord和ActivityRecord"><a href="#2-ActivityStack-、TaskRecord和ActivityRecord" class="headerlink" title="2. ActivityStack 、TaskRecord和ActivityRecord"></a>2. ActivityStack 、TaskRecord和ActivityRecord</h2><p>从ActivityStack#destroyActivityLocked（）&gt;&gt;     </p>
<p>ActivityStack#removeActivityFromHistoryLocked（）&gt;&gt;  </p>
<pre><code>final TaskRecord task = r.task;
if (task != null &amp;&amp; task.removeActivity(r)) {
    if (DEBUG_STACK) Slog.i(TAG,
             &quot;removeActivityFromHistoryLocked: last activity removed from &quot; + this);
     if (mStackSupervisor.isFrontStack(this) &amp;&amp; task == topTask() &amp;&amp; task.mOnTopOfHome) {
          mStackSupervisor.moveHomeToTop();
      }
       mStackSupervisor.removeTask(task);
  }
 r.takeFromHistory()
</code></pre><p>这里正式开始处理TaskRecord栈里面Activity记录</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/08/01/AMS浅析_01/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Liuycheng">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://github.com/liuyicheng3/learning-summary/blob/master/images/avatar.jpg?raw=true">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Nico随笔">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/08/01/AMS浅析_01/" itemprop="url">
                  AMS client端分析
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-08-01T00:00:00+08:00">
                2017-08-01
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Activity启动理解"><a href="#Activity启动理解" class="headerlink" title="Activity启动理解"></a>Activity启动理解</h1><p>PS：<br>一定要下载官方对应版本SDK，然后应用的SDK版本也要对应<br>建议配合GrepCode 查找类的位置，</p>
<h1 id="1-Android的CS模式"><a href="#1-Android的CS模式" class="headerlink" title="1. Android的CS模式"></a>1. Android的CS模式</h1><p>Android启动是通过AtivityThread的main函数启动的，<br>四大组件的生命周期都是通过AMS远程控制的，比如我们启动一个Acitivity,Service等都不是直接启动的，都是binder告诉AMS我们要启动四大组件，然后AMS通过binder处理（比如Activity A要启动Activity B，但是中途涉及到A的onpause  onStop和B 的oncreate，都是AMS依据ActivityRecord进行处理的）</p>
<h1 id="2-三个核心部分"><a href="#2-三个核心部分" class="headerlink" title="2. 三个核心部分"></a>2. 三个核心部分</h1><h2 id="client端："><a href="#client端：" class="headerlink" title="client端："></a>client端：</h2><p>ActivityThread<br>ActivityMangerNative   和ActivityManagerProxy<br>ApplicationThread和ApplicationThreadNative  </p>
<p>其实还涉及到：其它的比如 Instrumentation但是这个不是核心类</p>
<h2 id="Server端"><a href="#Server端" class="headerlink" title="Server端"></a>Server端</h2><p>ApplicationThreadProxy<br>ActivityMangerService<br>ProcessRecord<br>ActivityStack<br>ActivityRecord  </p>
<h2 id="跨进程通讯Binder"><a href="#跨进程通讯Binder" class="headerlink" title="跨进程通讯Binder"></a>跨进程通讯Binder</h2><p>Binder 和 Parcel</p>
<h1 id="3-Activity-A-启动Activity-B的流程详解"><a href="#3-Activity-A-启动Activity-B的流程详解" class="headerlink" title="3. Activity A 启动Activity B的流程详解"></a>3. Activity A 启动Activity B的流程详解</h1><p>ps：<br>ActivityMangerNative是往AMS发送消息的<br>ApplicationThread是从AMS接受指令消息的</p>
<h2 id="1、Client发送Intent"><a href="#1、Client发送Intent" class="headerlink" title="1、Client发送Intent"></a>1、Client发送Intent</h2><p>Activity#startActivity(Intent) &gt;&gt; Instrumentation#execStartActivity()  &gt;&gt;<br>ActivityManagerNative#startActivity() &gt;&gt;</p>
<h2 id="2、AMS-查询栈，告诉要Pause"><a href="#2、AMS-查询栈，告诉要Pause" class="headerlink" title="2、AMS 查询栈，告诉要Pause"></a>2、AMS 查询栈，告诉要Pause</h2><p>ActivityMangerNative#onTransact() &gt;&gt;    </p>
<p>ActivityMangerNative#schedulePauseActivity()这里是抽象的具体实现在<br>ActivityThread$ApplicationThread#schedulePauseActivity() &gt;&gt;   </p>
<p>ActivityThread#sendMessage() 也就是通过H mH 发送Message&gt;&gt;<br>ActivityThread$H#handleMessage()&gt;&gt;<br>ActivityThread#handlePauseActivity这里先要取出当前Activity ActivityClientRecord r = mActivities.get(token) &gt;&gt;<br>ActivityThread#performPauseActivity()&gt;&gt;    </p>
<p>Instrumentation#callActivityOnPause &gt;&gt;</p>
<p> ActivityManagerNative#activityPaused(token) 这个是在上一步Instrumentation pause完Activity后顺序执行的<br> 这里也就是通过binder发送消息&gt;&gt;  </p>
<p> PS:Activity切换要不要调用onstop 要看Theme，如果是android:style/Theme.Translucent就不会调用Onstop。所以我是不讲stop这个流程（实际上鄙人是有点懒。。。）</p>
<h2 id="3、AMS正式启动-Activity-B"><a href="#3、AMS正式启动-Activity-B" class="headerlink" title="3、AMS正式启动 Activity B"></a>3、AMS正式启动 Activity B</h2><p> ActivityMangerNative#onTransact() &gt;&gt;    </p>
<p>ActivityMangerNative#scheduleLaunchActivity()这里是抽象的具体实现在<br>ActivityThread$ApplicationThread#scheduleLaunchActivity() &gt;&gt;  </p>
<p>经过H mH转到主线程里面<br>ActivityThread#handleLaunchActivity&gt;&gt; </p>
<p>ActivityThread#performLaunchActivity<br>初始化Activity包括以下几步  </p>
<ol>
<li><p>生成Activity B ，这里仅仅是生成简单的java类 </p>
<pre><code>java.lang.ClassLoader cl = r.packageInfo.getClassLoader();
         activity = mInstrumentation.newActivity(
                 cl, component.getClassName(), r.intent);  
</code></pre></li>
<li><p>附加给Activity 各种Android系统类型</p>
<pre><code>attach(Context context, ActivityThread aThread,
    Instrumentation instr, IBinder token, int ident,
    Application application, Intent intent, ActivityInfo info,
    CharSequence title, Activity parent, String id,
    NonConfigurationInstances lastNonConfigurationInstances,
    Configuration config, String referrer, IVoiceInteractor voiceInteractor) 
</code></pre></li>
<li><p>回调oncreate  注意这个地方不会通知AMS</p>
<pre><code>mInstrumentation.callActivityOnCreate(activity, r.state);  
</code></pre></li>
</ol>
<p>最终这个会调用到Activity的oncreate</p>
<p>ps：ActivityThread.H 的Message可以看看，就可以知道有哪些操作需要和AMS打交道 </p>
<blockquote>
<blockquote>
</blockquote>
</blockquote>
<p>ActivityThread#handleResumeActivity<br>这里会依次调用</p>
<ol>
<li>ActivityThread#performResumeActivity(token, clearHide)   </li>
<li>ActivityManagerNative#willActivityBeVisible（）<br>告诉AMS Activity已经准备好了   </li>
<li>ActivityManagerNative#activityResumed（）<br>告诉AMS Activity已经resumed</li>
</ol>
<p>在2、3步骤里面就是做Activity B的界面绘制工作:</p>
<pre><code>r.window = r.activity.getWindow();
View decor = r.window.getDecorView();
decor.setVisibility(View.INVISIBLE);
ViewManager wm = a.getWindowManager();
a.mDecor = decor;
l.type = WindowManager.LayoutParams.TYPE_BASE_APPLICATION;
l.softInputMode |= forwardBit;
if (a.mVisibleFromClient) {
    a.mWindowAdded = true;
    wm.addView(decor, l);
    }
</code></pre><p>具体流程参考ActivityThread#handleResumeActivity()流程</p>
<p>涉及到window，DecroView等</p>
<h2 id="AMS-通知显示Acitivity-B已经Onresume，"><a href="#AMS-通知显示Acitivity-B已经Onresume，" class="headerlink" title="AMS 通知显示Acitivity B已经Onresume，"></a>AMS 通知显示Acitivity B已经Onresume，</h2><p>然后就是和onpause一样的流程并且回调Activity的onResume</p>
<h1 id="4-哪些是公用的，为hook做准备"><a href="#4-哪些是公用的，为hook做准备" class="headerlink" title="4. 哪些是公用的，为hook做准备"></a>4. 哪些是公用的，为hook做准备</h1>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/06/01/分析UI流畅度/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Liuycheng">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://github.com/liuyicheng3/learning-summary/blob/master/images/avatar.jpg?raw=true">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Nico随笔">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/06/01/分析UI流畅度/" itemprop="url">
                  Android 性能检测
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-06-01T00:00:00+08:00">
                2017-06-01
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="手机端："><a href="#手机端：" class="headerlink" title="手机端："></a>手机端：</h1><h2 id="开发者选项"><a href="#开发者选项" class="headerlink" title="开发者选项"></a>开发者选项</h2><ol>
<li><p>绘图》 显示布局边界</p>
</li>
<li><p>硬件加速渲染 》调试GPU过渡绘制  要打开</p>
</li>
</ol>
<ol>
<li><p>监控》启用严格模式</p>
</li>
<li><p>GPU呈现模式分析  可以对照颜色表找出耗时出在那一部分<br><img src="https://github.com/liuyicheng3/learning-summary/blob/master/images/GPU%E6%B8%B2%E6%9F%93%E6%A8%A1%E5%BC%8F.jpg?raw=true" alt="image"></p>
</li>
</ol>
<h1 id="电脑端："><a href="#电脑端：" class="headerlink" title="电脑端："></a>电脑端：</h1><ol>
<li><p>查看MemoryMonitor  ，查看页面内存波动（对于listview ）</p>
</li>
<li><p>tools》android》android  device  monistor<br>（其实它就是把android sdk中tools下面的很多功能聚合起来；  如ddms，uiautomatorviewer，monitor等功能聚合起来，但是好像没有集成hierarchyviewer的功能）</p>
</li>
<li><p>查看录制页面变化时候的cpu耗时<br>开始录制》选中进程，点击红色方框左边的按钮，然后点击红色方框里右侧的按钮录制正式开始，需要结束时，再点击右侧按钮结束，就会有结果自动生成<br><img src="https://github.com/liuyicheng3/learning-summary/blob/master/images/%E5%88%86%E6%9E%90%E8%80%97%E6%97%B6.png?raw=true" alt="image"></p>
<p>分析结果》录制实际上是一个采样的过程，可以看图中红色方框里面最耗时的几个方法，基本上可以定位到程序的问题<br><img src="https://github.com/liuyicheng3/learning-summary/blob/master/images/%E5%88%86%E6%9E%90%E8%80%97%E6%97%B6_2.png?raw=true" alt="image"></p>
</li>
<li>查看布局层次，以及每一层的绘制时间，目的是减小层次<br>入口是在：tools 下面 hierarchyviewer  查看每个层次的绘制时间（这个好像必须在模拟器上看）</li>
</ol>
<h1 id="分析卡的原因"><a href="#分析卡的原因" class="headerlink" title="分析卡的原因"></a>分析卡的原因</h1><h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p><a href="http://www.cnblogs.com/krislight1105/p/5352500.html" target="_blank" rel="external">http://www.cnblogs.com/krislight1105/p/5352500.html</a><br><a href="http://blog.csdn.net/wangbaochu/article/details/50396512" target="_blank" rel="external">http://blog.csdn.net/wangbaochu/article/details/50396512</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right"></i></a>
  </nav>


          
          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="https://github.com/liuyicheng3/learning-summary/blob/master/images/avatar.jpg?raw=true"
               alt="Liuycheng" />
          <p class="site-author-name" itemprop="name">Liuycheng</p>
           
              <p class="site-description motion-element" itemprop="description"></p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">33</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              
                <span class="site-state-item-count">8</span>
                <span class="site-state-item-name">分类</span>
              
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              
                <span class="site-state-item-count">33</span>
                <span class="site-state-item-name">标签</span>
              
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Liuycheng</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    
    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  




  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  



  




	





  





  





  



  
  

  

  

  

  


  

</body>
</html>
